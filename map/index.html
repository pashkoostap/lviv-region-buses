<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet-src.js"></script>
    <title>Document</title>
    <style>
      body {
        margin: 0;
      }
      .leaflet-div-icon {
        padding: 5px;
        border-radius: 50%;
        border: 1px solid blue;
      }

      #map {
        height: 100vh;
      }

      #form {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 10000;
      }
    </style>
  </head>
  <body>
    <form id="form">
      <select id="date">
        <option value="1558213200000">19-05-2019 Неділя</option>
        <option value="1558299600000">22-05-2019 Понеділок</option>
        <option value="1558386000000">21-05-2019 Вівторок</option>
        <option value="1558472400000">22-05-2019 Середа</option>
        <option value="1558558800000">23-05-2019 Четвер</option>
        <option value="1558645200000">24-05-2019 П'ятниця</option>
        <option value="1558731600000">25-05-2019 Субота</option>
        <option value="1558818000000">26-05-2019 Неділя</option>
        <option value="1558904400000">27-05-2019 Понеділок</option>
        <option value="1558990800000">28-05-2019 Вівторок</option>
        <option value="1559077200000">29-05-2019 Середа</option>
        <option value="1559163600000">30-05-2019 Четвер</option>
        <option value="1559250000000">31-05-2019 П'ятниця</option>
      </select>

      <select id="routeId"></select>

      <button type="submit">Find</button>
    </form>

    <script>
      const routeSelect = document.querySelector("#routeId");
      const dateSelect = document.querySelector("#date");
      document.querySelector("#form").addEventListener("submit", e => {
        e.preventDefault();
        var routeId = routeSelect.value;
        var date = dateSelect.value;

        initMap(routeId, date);
      });
      routeSelect.addEventListener("change", onSelectChange);
      dateSelect.addEventListener("change", onSelectChange);

      function onSelectChange() {
        if (routeSelect.value && dateSelect.value) {
          initMap(routeSelect.value, dateSelect.value);
        }
      }

      function loadRoutes() {
        window
          .fetch("/routes")
          .then(res => res.json())
          .then(routes => {
            const routeSelect = document.getElementById("routeId");
            routes.forEach(route => {
              const option = document.createElement("option");
              option.innerText = route.Name;
              option.value = route.Id;
              routeSelect.appendChild(option);
            });
          });
      }

      loadRoutes();

      function initMap(routeId, date) {
        var old = document.querySelector("#map");
        if (old) {
          old.remove();
        }
        var node = document.createElement("div");
        node.setAttribute("id", "map");
        document.body.appendChild(node);

        var map = L.map("map");
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution:
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        window
          .fetch(`/routes/1?routeId=${routeId}&date=${date}`)
          .then(res => res.json())
          .then(({ routeVehicles }) => {
            var pointsForJson = routeVehicles
              .filter(item => item.X && item.Y)
              .filter((item, i, arr) => {
                const next = arr[i + 1];
                const trashhold = 0.001;
                return next
                  ? Math.abs(next.X - item.X) > trashhold &&
                      Math.abs(next.Y - item.Y) > trashhold
                  : true;
              })
              .map(item => [item.X, item.Y, item.created]);

            if (pointsForJson.length) {
              pointsForJson.forEach(function(lngLat, i) {
                L.marker(lngLatToLatLng(lngLat), {
                  icon: new L.divIcon({
                    html: `<div>${i}</div>`
                  })
                })
                  .addTo(map)
                  .bindPopup(`<p>${new Date(lngLat[2])}</p>`);
              });
              var polyline = L.polyline(
                lngLatArrayToLatLng(pointsForJson)
              ).addTo(map);

              map.fitBounds(polyline.getBounds());
            }
          });

        function lngLatArrayToLatLng(lngLatArray) {
          return lngLatArray.map(lngLatToLatLng);
        }

        function lngLatToLatLng(lngLat) {
          return [lngLat[1], lngLat[0]];
        }
      }
    </script>
  </body>
</html>
